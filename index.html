<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Hôtel Avancée - Facturation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #eef2f7;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 10vh;
        }
        .container {
            max-width: 950px;
            width: 100%;
            margin: 20px auto;
            background-color: #fff;
            padding: 35px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2em;
            font-weight: 600;
        }
        h2 {
            color: #34495e;
            text-align: left;
            margin-bottom: 20px;
            font-size: 1.6em;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 8px;
        }
        .form-section {
            padding: 25px;
            border: 1px solid #e0e6ed;
            border-radius: 10px;
            background-color: #fcfdff;
            transition: all 0.3s ease;
        }
        .form-section:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        .form-group {
            margin-bottom: 18px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a657c;
            font-size: 0.95em;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid #c8d6e5;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }
        /* Styles pour les champs en erreur */
        .form-group input.input-error,
        .form-group select.input-error,
        .form-group textarea.input-error {
            border-color: #e74c3c !important;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.25) !important;
        }
        .error-message {
            color: #e74c3c;
            font-size: 0.85em;
            margin-top: 5px;
            display: none; /* Caché par défaut */
        }

        .form-group input[type="date"],
        .form-group input[type="time"] {
            width: auto;
            min-width: 180px;
        }
        .time-fields {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .time-fields .form-group {
            flex: 1;
            margin-bottom: 0;
        }


        /* Dynamic Services */
        #services-list {
            margin-top: 15px;
        }
        .service-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }
        .service-item input {
            padding: 8px;
            border: 1px solid #c8d6e5;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 0.95em;
        }
        .service-item .service-description {
            flex-grow: 2;
        }
        .service-item .service-quantity {
            flex-grow: 1;
            max-width: 100px;
        }
        .service-item .service-unit-price {
            flex-grow: 1;
            max-width: 120px;
        }
        .service-item button {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s ease;
        }
        .service-item button:hover {
            background-color: #c0392b;
        }
        #addServiceButton {
            background-color: #28a745;
            padding: 8px 15px;
            border-radius: 5px;
            border: none;
            color: white;
            cursor: pointer;
            margin-top: 10px;
            font-size: 0.95em;
            transition: background-color 0.2s ease;
        }
        #addServiceButton:hover {
            background-color: #218838;
        }

        /* Buttons */
        .button-group {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e6ed;
        }
        .button-group button {
            padding: 12px 25px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1em;
            margin: 0 12px;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .button-group button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }
        .button-group button:active {
            transform: translateY(0);
        }

        /* Invoice Preview */
        #invoice-preview {
            display: none; /* Hidden by default */
            border: 1px solid #ddd;
            padding: 25px;
            margin-top: 30px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        #invoice-preview h2 {
            text-align: center;
            color: #0056b3;
            margin-bottom: 25px;
            font-size: 1.8em;
        }
        #invoice-header .hotel-info {
            text-align: center;
            margin-bottom: 20px;
        }
        #invoice-header .hotel-info p {
            margin: 5px 0;
            font-size: 1.1em;
            font-weight: bold;
            color: #2c3e50;
        }
        #invoice-header .hotel-info span {
            font-weight: normal;
            font-size: 0.95em;
            color: #555;
            display: block;
        }
        #invoice-header .invoice-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        #invoice-details div {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }
        #invoice-header p, #invoice-details p {
            margin: 0;
            font-size: 0.95em;
            flex-basis: 48%; /* For two columns */
        }
        #invoice-header p strong, #invoice-details p strong {
            color: #2c3e50;
        }
        #invoice-items table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.95em;
        }
        #invoice-items th, #invoice-items td {
            border: 1px solid #eee;
            padding: 10px;
            text-align: left;
        }
        /* Spacing for P.U and P.T columns */
        #invoice-items th:nth-child(2), /* P.U column header */
        #invoice-items td:nth-child(2) { /* P.U column data */
            padding-right: 20px; /* Add more space to the right of P.U */
        }

        #invoice-items th:nth-child(3), /* P.T column header */
        #invoice-items td:nth-child(3) { /* P.T column data */
            padding-left: 20px; /* Add more space to the left of P.T */
        }

        #invoice-items th {
            background-color: #f8f8f8;
            font-weight: 700;
            color: #555;
        }
        #invoice-items tr:last-child td {
            border-bottom: none;
        }
        #invoice-total {
            text-align: right;
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 25px;
            border-top: 1px solid #e0e6ed;
            padding-top: 15px;
        }
        #invoice-total p {
            margin: 8px 0;
            color: #2c3e50;
        }
        #invoice-total .final-total {
            color: #007bff;
            font-size: 1.3em;
            border-top: 2px solid #007bff;
            padding-top: 10px;
            margin-top: 15px;
        }
        #invoice-footer {
            text-align: center;
            color: #777;
            border-top: 1px solid #e0e6ed;
            padding-top: 15px;
            font-size: 1.0em; /* Increased font size */
        }
        #invoice-footer p {
            font-weight: bold; /* Make the text bold */
            margin: 0;
        }


        /* Indicateur de chargement pour le PDF */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            z-index: 1000;
        }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            .form-section {
                padding: 15px;
            }
            h1 {
                font-size: 1.8em;
            }
            h2 {
                font-size: 1.4em;
            }
            .button-group button {
                padding: 10px 20px;
                font-size: 1em;
                margin: 0 5px;
            }
            #invoice-details div {
                flex-basis: 100%; /* Stack on small screens */
                flex-direction: column;
            }
            #invoice-details p {
                flex-basis: 100%;
            }
            #invoice-header .invoice-meta {
                flex-direction: column;
            }
            #invoice-header .invoice-meta p {
                 flex-basis: 100%;
                 text-align: center;
            }
        }

        /* Styles spécifiques pour l'impression thermique */
        @media print {
            body {
                width: 80mm; /* Largeur typique d'un rouleau d'imprimante thermique */
                margin: 0;
                padding: 0;
                background-color: #fff;
                font-family: 'Consolas', 'Courier New', monospace; /* Police plus adaptée aux reçus */
                font-size: 10pt; /* Taille de police de base pour le corps */
                overflow: hidden; /* Empêcher le défilement */
            }
            .container {
                width: 100%;
                box-shadow: none;
                border-radius: 0;
                padding: 5mm; /* Petites marges internes */
                margin: 0;
                display: block;
            }
            .form-section, .button-group, h1 {
                display: none; /* Masquer le formulaire, les boutons et le titre principal */
            }
            #invoice-preview {
                display: block !important;
                border: none;
                box-shadow: none;
                margin: 0;
                /* Modifications ici pour la largeur et le padding */
                width: 72mm; /* Largeur fixe pour l'imprimante thermique, ajustez si votre rouleau est 80mm */
                max-width: 72mm; /* S'assurer qu'il ne dépasse pas cette largeur */
                padding: 3mm; /* Réduire le padding pour laisser plus de place au contenu */
                box-sizing: border-box; /* Assure que padding est inclus dans la largeur */
                font-family: 'Consolas', 'Monospace', sans-serif; /* Application de la police monospace */
                font-size: 11pt; /* Ajustement de la taille de police globale pour l'aperçu */
            }

            #invoice-preview h2 {
                font-size: 1.2em; /* Titre "Facture" plus petit */
                margin-top: 0;
                margin-bottom: 10px;
                padding-bottom: 5px;
                border-bottom: 1px dashed #bbb; /* Ligne pointillée */
                color: #000; /* Texte noir pour l'impression */
            }

            #invoice-header .hotel-info p {
                font-size: 1.1em;
                font-weight: bold;
                margin-bottom: 3px;
                color: #000; /* Assurer que le texte est noir */
            }
            #invoice-header .hotel-info span {
                font-size: 10.5pt; /* Rendu plus lisible pour l'adresse et le téléphone */
                color: #000;
                margin-bottom: 2px;
                line-height: 1.3; /* Assurer un bon espacement */
            }
            #invoice-header .invoice-meta {
                flex-direction: column; /* Stack les éléments */
                margin-top: 10px;
                margin-bottom: 10px;
                padding-bottom: 8px;
                border-bottom: 1px dashed #bbb;
            }
            #invoice-header .invoice-meta p {
                font-size: 10.5pt; /* Augmenter légèrement la taille des paragraphes */
                margin-bottom: 3px;
                text-align: left; /* Aligner à gauche */
                flex-basis: 100%;
                line-height: 1.4; /* Assurer un bon espacement des lignes */
                color: #000; /* Assurer que le texte est noir */
            }
            #invoice-header p strong, #invoice-details p strong {
                font-weight: 700; /* S'assurer qu'ils sont bien en gras et ressortent */
                color: #000;
            }

            #invoice-details h3, #invoice-items h3 {
                font-size: 1.1em; /* Légèrement plus grands que le texte normal */
                font-weight: 700; /* En gras */
                text-align: left;
                margin-top: 10px;
                margin-bottom: 8px;
                padding-bottom: 3px;
                border-bottom: 1px dashed #bbb;
                color: #000;
            }
            #invoice-details div {
                flex-direction: column;
                margin-bottom: 5px;
            }
            #invoice-details p {
                font-size: 10.5pt; /* Augmenter légèrement la taille des paragraphes */
                margin-bottom: 2px;
                flex-basis: 100%;
                line-height: 1.4; /* Assurer un bon espacement des lignes */
                color: #000; /* Assurer que le texte est noir */
            }

            #invoice-items table {
                font-size: 0.9em;
                margin-top: 10px;
                border: none; /* Supprimer les bordures de tableau */
            }
            #invoice-items th, #invoice-items td {
                /* Modifications ici pour les bordures de tableau */
                border: none;
                border-bottom: 1px dashed #ccc; /* Bordure en pointillés pour chaque ligne */
                padding: 4px 0; /* Réduire le padding */
                font-size: 10.5pt; /* Taille de police pour les éléments du tableau */
                color: #000; /* Assurer que le texte est noir */
            }
            /* Spacing for P.U and P.T columns in print */
            #invoice-items th:nth-child(2), /* P.U column header */
            #invoice-items td:nth-child(2) { /* P.U column data */
                padding-right: 10px; /* Reduced for print */
            }

            #invoice-items th:nth-child(3), /* P.T column header */
            #invoice-items td:nth-child(3) { /* P.T column data */
                padding-left: 10px; /* Reduced for print */
            }

            #invoice-items th {
                background-color: transparent; /* Pas de fond */
                font-weight: 700; /* S'assurer qu'ils sont bien en gras */
                color: #000;
                border-bottom: 2px solid #000; /* Ligne plus épaisse pour l'en-tête */
                padding-bottom: 8px;
            }
            #invoice-items tr:last-child td {
                border-bottom: none; /* Pas de bordure après le dernier élément du tableau */
            }

            #invoice-total {
                font-size: 11pt; /* Taille de police pour le sous-total */
                margin-top: 15px;
                padding-top: 10px;
                border-top: 1px dashed #bbb; /* Ligne pointillée */
                font-weight: normal; /* Par défaut */
                color: #000;
            }
            #invoice-total p {
                font-size: 11pt; /* Taille de police pour le sous-total */
                margin-bottom: 5px;
                color: #000;
            }
            #invoice-total .final-total {
                font-size: 1.2em; /* Taille plus grande pour le total général */
                font-weight: 700; /* En gras */
                color: #000; /* Assurer qu'il est bien noir */
                border-top: 1px dashed #bbb; /* Ligne pointillée */
                padding-top: 8px;
                margin-top: 10px;
            }

            #invoice-footer {
                font-size: 0.9em; /* Adjusted for print */
                margin-top: 15px;
                padding-top: 10px;
                border-top: 1px dashed #bbb;
                color: #555;
            }
            #invoice-footer p {
                font-weight: bold; /* Make the text bold for print */
                color: #000; /* Ensure text is black for print */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Facturation Hôtelière</h1>

        <div class="form-section">
            <h2>Informations du Client</h2>
            <div class="form-group">
                <label for="clientName">Nom Complet du Client: <span style="color: red;">*</span></label>
                <input type="text" id="clientName" required>
                <div id="clientNameError" class="error-message">Le nom du client est requis.</div>
            </div>
            <div class="form-group">
                <label for="clientId">Pièce d'Identité:</label>
                <select id="clientId">
                    <option value="">Sélectionner un type</option>
                    <option value="Carte d'électeur">Carte d'électeur</option>
                    <option value="Passport">Passport</option>
                    <option value="Carte de service">Carte de service</option>
                    <option value="Carte d'identité">Carte d'identité</option>
                </select>
            </div>
            <div class="form-group">
                <label for="partnerName">Nom du Partenaire:</label>
                <input type="text" id="partnerName">
            </div>
            <div class="form-group">
                <label for="partnerAddress">Adresse du Partenaire:</label>
                <textarea id="partnerAddress" rows="2"></textarea>
            </div>
            <div class="form-group">
                <label for="clientAddress">Adresse du Client:</label>
                <textarea id="clientAddress" rows="2"></textarea>
            </div>
            <div class="form-group">
                <label for="clientPhone">Téléphone du Client:</label>
                <input type="text" id="clientPhone">
            </div>
            </div>

        <div class="form-section">
            <h2>Détails du Séjour et Services</h2>
            <div class="form-group">
                <label for="roomNumber">Numéro de Chambre: <span style="color: red;">*</span></label>
                <input type="text" id="roomNumber" required>
                <div id="roomNumberError" class="error-message">Le numéro de chambre est requis.</div>
            </div>
            <div class="form-group">
                <label for="roomCategory">Catégorie de la Chambre: <span style="color: red;">*</span></label>
                <select id="roomCategory" required>
                    <option value="A">Catégorie A</option>
                    <option value="B">Catégorie B</option>
                </select>
            </div>
            <div class="form-group">
                <label for="stayMotive">Motif du Séjour: <span style="color: red;">*</span></label>
                <select id="stayMotive" required>
                    <option value="repos">Repos (3h)</option>
                    <option value="nuit">Nuit (22h à 10h)</option>
                    <option value="logement_jour">Logement par Jour</option>
                </select>
            </div>

            <div id="stayDatesSection"> <div class="form-group" id="checkInDateGroup">
                    <label for="checkInDate">Date d'Arrivée / Date du Séjour: <span style="color: red;">*</span></label>
                    <input type="date" id="checkInDate" required>
                    <div id="checkInDateError" class="error-message">La date d'arrivée est requise.</div>
                </div>
                <div class="form-group" id="checkOutDateGroup">
                    <label for="checkOutDate">Date de Départ: <span style="color: red;">*</span></label>
                    <input type="date" id="checkOutDate" required>
                    <div id="checkOutDateError" class="error-message">La date de départ est requise et doit être après la date d'arrivée.</div>
                </div>
            </div>

            <div id="reposeTimes" style="display: none;">
                <div class="form-group">
                    <label for="reposeCheckInTime">Heure d'Arrivée (Repos):</label>
                    <input type="time" id="reposeCheckInTime">
                </div>
                <div class="form-group">
                    <label for="reposeCheckOutTime">Heure de Sortie (Repos):</label>
                    <input type="time" id="reposeCheckOutTime">
                </div>
            </div>

            <h3>Services Additionnels</h3>
            <div id="services-list">
                </div>
            <button type="button" id="addServiceButton">+ Ajouter un service</button>

            <h3>Réduction</h3>
            <div class="form-group">
                <label for="discountType">Type de Réduction:</label>
                <select id="discountType">
                    <option value="none">Aucune</option>
                    <option value="percentage">Pourcentage (%)</option>
                    <option value="amount">Montant Fixe (USD)</option>
                </select>
            </div>
            <div class="form-group" id="discountValueGroup" style="display: none;">
                <label for="discountValue">Valeur de la Réduction:</label>
                <input type="number" id="discountValue" min="0" value="0">
                <div id="discountValueError" class="error-message">Veuillez entrer une valeur de réduction valide.</div>
            </div>
        </div>

        <div class="button-group">
            <button onclick="generateInvoice()">Générer Facture</button>
            <button onclick="printInvoice()" id="printButton" style="display: none;">Imprimer Facture</button>
            <button onclick="downloadPdf()" id="downloadPdfButton" style="display: none;">Télécharger PDF</button>
        </div>

        <div class="loading-overlay" id="loadingOverlay">
            Génération du PDF...
        </div>

        <div id="invoice-preview">
            <h2>Facture</h2>
            <div id="invoice-header">
                <div class="hotel-info">
                    <p>FLAT HÔTEL ETATS-UNIS</p>
                    <span>284, BIABU Q/ADOULA C/BANDALUNGA, Kinshasa, R.D. Congo</span>
                    <span>Téléphone: +243 984655350</span>
                </div>
                <div class="invoice-meta">
                    <p><strong>Facture N°:</strong> <span id="invoiceNumber"></span></p>
                    <p><strong>Date de Facturation:</strong> <span id="invoiceDate"></span></p>
                </div>
            </div>

            <div id="invoice-details">
                <h3>Détails du Client</h3>
                <div>
                    <p><strong>Nom:</strong> <span id="previewClientName"></span></p>
                    <p><strong>Pièce d'Identité:</strong> <span id="previewClientId"></span></p>
                </div>
                <div>
                    <p><strong>Nom Partenaire:</strong> <span id="previewPartnerName"></span></p>
                    <p><strong>Adresse Partenaire:</strong> <span id="previewPartnerAddress"></span></p>
                </div>
                <div>
                    <p><strong>Adresse Client:</strong> <span id="previewClientAddress"></span></p>
                    <p><strong>Téléphone Client:</strong> <span id="previewClientPhone"></span></p>
                </div>
                <div>
                    <p><strong>Numéro Chambre:</strong> <span id="previewRoomNumber"></span></p>
                    <p><strong>Catégorie Chambre:</strong> <span id="previewRoomCategory"></span></p>
                </div>
                <div>
                    <p><strong>Motif Séjour:</strong> <span id="previewStayMotive"></span></p>
                    <p id="previewStayPeriodLabel">Durée du Séjour:</p>
                </div>
            </div>

            <div id="invoice-items">
                <h3>Articles</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Desc</th>
                            <th>P.U</th>
                            <th>P.T</th>
                        </tr>
                    </thead>
                    <tbody id="invoice-items-body">
                        </tbody>
                </table>
            </div>

            <div id="invoice-total">
                <p>Sous-total: <span id="subTotal">0.00</span> USD</p>
                <p class="final-total">Total Général: <span id="grandTotal">0.00</span> USD</p>
            </div>

            <div id="invoice-footer">
                <p>Merci de votre séjour à FLAT HÔTEL ETATS-UNIS !</p>
            </div>
        </div>
    </div>

    <script>
        // Informations de l'hôtel (fixes)
        const HOTEL_INFO = {
            name: "FLAT HÔTEL ETATS-UNIS",
            address: "284, BIABU Q/ADOULA C/BANDALUNGA, Kinshasa, R.D. Congo",
            city: "Kinshasa",
            country: "R.D. Congo",
            phone: "+243 984655350",
            email: "contact@flathoteletatsunis.com" // L'email est maintenu ici pour d'autres usages futurs mais non affiché
        };

        // Tarifs des motifs de séjour
        const STAY_RATES = {
            'repos_A': 30.00,
            'repos_B': 20.00,
            'nuit_A': 40.00,
            'nuit_B': 30.00,
            'logement_jour_A': 50.00,
            'logement_jour_B': 40.00
        };

        // Fonctionnalité de stockage local
        const saveForm = () => {
            const formInputs = document.querySelectorAll('.form-section input, .form-section textarea, .form-section select');
            const services = [];
            document.querySelectorAll('.service-item').forEach(item => {
                services.push({
                    description: item.querySelector('.service-description').value,
                    unitPrice: item.querySelector('.service-unit-price').value
                });
            });

            const data = {};
            formInputs.forEach(input => {
                if (!input.id.startsWith('hotel') && input.id !== 'clientEmail') { // Exclure clientEmail de la sauvegarde
                    data[input.id] = input.value;
                }
            });
            data['services'] = services;
            localStorage.setItem('hotelInvoiceForm', JSON.stringify(data));
        };

        const loadForm = () => {
            const savedData = localStorage.getItem('hotelInvoiceForm');
            if (savedData) {
                const data = JSON.parse(savedData);
                for (const id in data) {
                    const input = document.getElementById(id);
                    if (input && id !== 'clientEmail') { // Exclure clientEmail du chargement
                        input.value = data[id];
                    }
                }
                // Charger les services
                const servicesList = document.getElementById('services-list');
                servicesList.innerHTML = ''; // Effacer les services existants avant le chargement
                if (data.services && data.services.length > 0) {
                    data.services.forEach(service => {
                        addService(service.description, undefined, service.unitPrice);
                    });
                } else {
                    addService(); // Ajouter un service vide si aucun n'est sauvegardé
                }
            } else {
                addService(); // Ajouter un service vide si aucune donnée n'est sauvegardée
            }
            updateStayMotiveFields(); // Mettre à jour la visibilité en fonction des données chargées
        };

        // Fonction pour gérer la visibilité des champs selon le motif du séjour
        function updateStayMotiveFields() {
            const stayMotive = document.getElementById('stayMotive').value;
            const checkInDateGroup = document.getElementById('checkInDateGroup');
            const checkOutDateGroup = document.getElementById('checkOutDateGroup');
            const reposeTimes = document.getElementById('reposeTimes');
            const checkInDateLabel = document.querySelector('#checkInDateGroup label');

            // Réinitialiser d'abord les attributs 'required'
            document.getElementById('checkInDate').removeAttribute('required');
            document.getElementById('checkOutDate').removeAttribute('required');

            if (stayMotive === 'logement_jour') {
                checkInDateGroup.style.display = 'block';
                checkOutDateGroup.style.display = 'block';
                reposeTimes.style.display = 'none';
                checkInDateLabel.textContent = 'Date d\'Arrivée: *';
                document.getElementById('checkInDate').setAttribute('required', 'true');
                document.getElementById('checkOutDate').setAttribute('required', 'true');
            } else if (stayMotive === 'repos') {
                checkInDateGroup.style.display = 'block';
                checkOutDateGroup.style.display = 'none'; // La date de départ n'est pas pertinente pour Repos
                reposeTimes.style.display = 'block';
                checkInDateLabel.textContent = 'Date du Séjour: *';
                document.getElementById('checkInDate').setAttribute('required', 'true');
            } else { // 'nuit'
                checkInDateGroup.style.display = 'block'; // Toujours besoin d'une date pour "Nuit"
                checkOutDateGroup.style.display = 'none';
                reposeTimes.style.display = 'none';
                checkInDateLabel.textContent = 'Date du Séjour: *';
                document.getElementById('checkInDate').setAttribute('required', 'true');
            }
            generateInvoice(); // Régénérer la facture après les changements de visibilité des champs
        }

        // Fonctions pour les services dynamiques
        function addService(description = '', quantity = 1, unitPrice = 0) { // Garder le paramètre quantity pour la compatibilité
            const servicesList = document.getElementById('services-list');
            const serviceItem = document.createElement('div');
            serviceItem.classList.add('service-item');
            serviceItem.innerHTML = `
                <input type="text" class="service-description" placeholder="Description du service" value="${description}">
                <input type="number" class="service-unit-price" value="${parseFloat(unitPrice).toFixed(2)}" min="0" step="0.01">
                <button type="button" onclick="removeService(this)">Supprimer</button>
            `;
            servicesList.appendChild(serviceItem);

            // Pas besoin d'attacher des écouteurs ici, car nous utilisons la délégation d'événements
            saveForm();
        }

        function removeService(button) {
            const serviceItem = button.closest('.service-item');
            serviceItem.remove();
            generateInvoice();
            saveForm();
        }

        // Fonction principale pour générer la facture
        function generateInvoice() {
            // Réinitialiser les messages d'erreur et les styles
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            document.querySelectorAll('input.input-error, select.input-error').forEach(el => el.classList.remove('input-error'));

            let isValid = true; // Variable pour suivre la validité du formulaire

            const clientNameInput = document.getElementById('clientName');
            const roomNumberInput = document.getElementById('roomNumber');
            const checkInDateInput = document.getElementById('checkInDate');
            const checkOutDateInput = document.getElementById('checkOutDate');
            const roomCategoryInput = document.getElementById('roomCategory');
            const stayMotiveInput = document.getElementById('stayMotive');

            // Récupérer les nouvelles valeurs de réduction
            const discountType = document.getElementById('discountType').value;
            const discountValueInput = document.getElementById('discountValue');
            let discountValue = parseFloat(discountValueInput.value) || 0;

            // --- Validation des champs requis ---
            if (clientNameInput.value.trim() === '') {
                document.getElementById('clientNameError').style.display = 'block';
                clientNameInput.classList.add('input-error');
                isValid = false;
            }
            if (roomNumberInput.value.trim() === '') {
                document.getElementById('roomNumberError').style.display = 'block';
                roomNumberInput.classList.add('input-error');
                isValid = false;
            }
            if (stayMotiveInput.value.trim() === '') {
                stayMotiveInput.classList.add('input-error');
                isValid = false; // Ce champ a déjà un "required" dans le HTML, mais c'est une vérification supplémentaire
            }
             if (roomCategoryInput.value.trim() === '') {
                roomCategoryInput.classList.add('input-error');
                isValid = false;
            }

            // Validation du champ de réduction
            if (discountType !== 'none' && (isNaN(discountValue) || discountValue < 0)) {
                document.getElementById('discountValueError').style.display = 'block';
                discountValueInput.classList.add('input-error');
                isValid = false;
            }


            const stayMotive = stayMotiveInput.value;
            const checkInDateStr = checkInDateInput.value;
            const checkOutDateStr = checkOutDateInput.value;

            if (checkInDateStr.trim() === '') {
                document.getElementById('checkInDateError').style.display = 'block';
                checkInDateInput.classList.add('input-error');
                isValid = false;
            }

            if (stayMotive === 'logement_jour') {
                if (checkOutDateStr.trim() === '') {
                    document.getElementById('checkOutDateError').style.display = 'block';
                    checkOutDateInput.classList.add('input-error');
                    isValid = false;
                } else {
                    const checkInDate = new Date(checkInDateStr);
                    const checkOutDate = new Date(checkOutDateStr);
                    if (checkOutDate <= checkInDate) {
                        document.getElementById('checkOutDateError').textContent = "La date de départ doit être après la date d'arrivée.";
                        document.getElementById('checkOutDateError').style.display = 'block';
                        checkOutDateInput.classList.add('input-error');
                        isValid = false;
                    }
                }
            }

            if (!isValid) {
                document.getElementById('invoice-preview').style.display = 'none';
                document.getElementById('printButton').style.display = 'none';
                document.getElementById('downloadPdfButton').style.display = 'none';
                return; // Arrête la génération si le formulaire n'est pas valide
            }
            // --- Fin de la validation ---


            const clientName = clientNameInput.value;
            const clientId = document.getElementById('clientId').value; // Maintenant lit depuis le select
            const partnerName = document.getElementById('partnerName').value;
            const partnerAddress = document.getElementById('partnerAddress').value; // Nouveau: Obtenir l'adresse du partenaire
            const clientAddress = document.getElementById('clientAddress').value;
            const clientPhone = document.getElementById('clientPhone').value;
            const roomNumber = roomNumberInput.value;
            const roomCategory = roomCategoryInput.value;


            let baseRoomPrice = STAY_RATES[`${stayMotive}_${roomCategory}`] || 0;
            let stayPeriodText = '';
            let roomTotal = 0;
            let numUnits = 1; // Par défaut à 1 pour les services sans quantité explicite

            const items = [];

            // Déterminer la durée du séjour et calculer le total de la chambre
            if (stayMotive === 'logement_jour') {
                const checkInDate = new Date(checkInDateStr);
                const checkOutDate = new Date(checkOutDateStr);

                const timeDiff = Math.abs(checkOutDate.getTime() - checkInDate.getTime());
                numUnits = Math.ceil(timeDiff / (1000 * 3600 * 24)); // Nombre de jours/nuits
                if (numUnits === 0 && checkInDateStr && checkOutDateStr && checkInDate.toDateString() === checkOutDate.toDateString()) {
                    numUnits = 1; // Minimum 1 jour si même jour
                } else if (numUnits === 0 && checkInDateStr && checkOutDateStr) {
                    numUnits = 0; // Plage de dates invalide, mis à 0 pour éviter le calcul
                }

                stayPeriodText = `Du ${new Date(checkInDateStr).toLocaleDateString('fr-FR')} au ${new Date(checkOutDateStr).toLocaleDateString('fr-FR')} (${numUnits} nuit(s))`;

                roomTotal = numUnits * baseRoomPrice;
            } else if (stayMotive === 'repos') {
                const reposeCheckInTime = document.getElementById('reposeCheckInTime').value;
                const reposeCheckOutTime = document.getElementById('reposeCheckOutTime').value;

                stayPeriodText = `Le ${new Date(checkInDateStr).toLocaleDateString('fr-FR')} de ${reposeCheckInTime || 'N/A'} à ${reposeCheckOutTime || 'N/A'}`;
                roomTotal = baseRoomPrice;
                numUnits = 1;
            } else { // 'nuit'
                stayPeriodText = `Le ${new Date(checkInDateStr).toLocaleDateString('fr-FR')} (De 22h à 10h)`;
                roomTotal = baseRoomPrice;
                numUnits = 1;
            }

            let subTotal = roomTotal;

            // Ajouter le coût de la chambre aux articles
            if (baseRoomPrice > 0 || roomTotal > 0) {
                 let roomDescription = `Chambre ${roomNumber ? '#' + roomNumber : ''} (Catégorie ${roomCategory})`;
                 if (stayMotive === 'repos') roomDescription += ' (Repos 3h)';
                 else if (stayMotive === 'nuit') roomDescription += ' (Nuit 22h-10h)';
                 else roomDescription += ' (Logement par Jour)';

                items.push({
                    description: roomDescription,
                    unitPrice: baseRoomPrice.toFixed(2),
                    total: roomTotal.toFixed(2)
                });
            }

            // Obtenir les services additionnels dynamiques
            document.querySelectorAll('.service-item').forEach(itemElement => {
                const description = itemElement.querySelector('.service-description').value;
                const unitPrice = parseFloat(itemElement.querySelector('.service-unit-price').value || 0);

                if (description && (unitPrice > 0)) {
                    const total = unitPrice;
                    items.push({
                        description: description,
                        unitPrice: unitPrice.toFixed(2),
                        total: total.toFixed(2)
                    });
                    subTotal += total;
                }
            });

            // Appliquer la réduction
            let totalDiscount = 0;
            if (discountType === 'percentage' && discountValue > 0 && discountValue <= 100) {
                totalDiscount = subTotal * (discountValue / 100);
            } else if (discountType === 'amount' && discountValue > 0) {
                totalDiscount = discountValue;
            }

            // Assurer que la réduction ne dépasse pas le sous-total
            if (totalDiscount > subTotal) {
                totalDiscount = subTotal;
            }

            // Calculer le total final après réduction
            const grandTotal = subTotal - totalDiscount;


            // Remplir l'aperçu de la facture
            document.getElementById('invoiceNumber').textContent = `FLAT-${Math.floor(Math.random() * 1000000)}`;
            const now = new Date();
            const invoiceDateTime = now.toLocaleDateString('fr-FR') + ' ' + now.toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});
            document.getElementById('invoiceDate').textContent = invoiceDateTime;

            // Définir les informations de l'hôtel directement à partir de la constante HOTEL_INFO
            document.querySelector('.hotel-info p').textContent = HOTEL_INFO.name;
            document.querySelector('.hotel-info span:nth-of-type(1)').textContent = `${HOTEL_INFO.address}, ${HOTEL_INFO.city}, ${HOTEL_INFO.country}`;
            document.querySelector('.hotel-info span:nth-of-type(2)').textContent = `Téléphone: ${HOTEL_INFO.phone}`;


            document.getElementById('previewClientName').textContent = clientName || 'N/A';
            document.getElementById('previewClientId').textContent = clientId || 'N/A';
            document.getElementById('previewPartnerName').textContent = partnerName || 'N/A';
            document.getElementById('previewPartnerAddress').textContent = partnerAddress || 'N/A'; // Nouveau: Afficher l'adresse du partenaire
            document.getElementById('previewClientAddress').textContent = clientAddress || 'N/A';
            document.getElementById('previewClientPhone').textContent = clientPhone || 'N/A';

            document.getElementById('previewRoomNumber').textContent = roomNumber || 'N/A';
            document.getElementById('previewRoomCategory').textContent = `Catégorie ${roomCategory}`;

            let motifDisplay = '';
            if (stayMotive === 'repos') motifDisplay = 'Repos (3h)';
            else if (stayMotive === 'nuit') motifDisplay = 'Nuit (22h à 10h)';
            else if (stayMotive === 'logement_jour') motifDisplay = 'Logement par Jour';
            document.getElementById('previewStayMotive').textContent = motifDisplay;

            document.getElementById('previewStayPeriodLabel').innerHTML = `<strong>Période:</strong> ${stayPeriodText}`;


            const itemsBody = document.getElementById('invoice-items-body');
            itemsBody.innerHTML = '';
            if (items.length === 0) {
                const row = itemsBody.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 3;
                cell.textContent = "Aucun article.";
                cell.style.textAlign = 'center';
                cell.style.fontStyle = 'italic';
                cell.style.color = '#777';
            } else {
                items.forEach(item => {
                    const row = itemsBody.insertRow();
                    row.insertCell(0).textContent = item.description;
                    row.insertCell(1).textContent = item.unitPrice;
                    row.insertCell(2).textContent = item.total;
                });
            }

            const invoiceTotalDiv = document.getElementById('invoice-total');
            let discountDisplayHtml = '';
            if (totalDiscount > 0) {
                discountDisplayHtml = `<p>Réduction: <span id="discountAmount">-${totalDiscount.toFixed(2)}</span> USD</p>`;
            }
            // Mettre à jour le HTML pour inclure la réduction
            invoiceTotalDiv.innerHTML = `
                <p>Sous-total: <span id="subTotal">${subTotal.toFixed(2)}</span> USD</p>
                ${discountDisplayHtml}
                <p class="final-total">Total Général: <span id="grandTotal">${grandTotal.toFixed(2)}</span> USD</p>
            `;


            document.getElementById('invoice-preview').style.display = 'block';
            document.getElementById('printButton').style.display = 'inline-block';
            document.getElementById('downloadPdfButton').style.display = 'inline-block';

            saveForm();
        }

        function printInvoice() {
            window.print();
        }

        function downloadPdf() {
            const invoiceElement = document.getElementById('invoice-preview');
            const originalDisplay = invoiceElement.style.display;
            const loadingOverlay = document.getElementById('loadingOverlay');

            loadingOverlay.style.display = 'flex';
            invoiceElement.style.display = 'block';

            setTimeout(() => {
                html2canvas(invoiceElement, {
                    scale: 4,
                    useCORS: true
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png', 0.9);
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const imgWidth = 210;
                    const pageHeight = 297;
                    let imgHeight = canvas.height * imgWidth / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;

                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft >= -1) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    pdf.save("facture_hotel.pdf");

                    invoiceElement.style.display = originalDisplay;
                    loadingOverlay.style.display = 'none';
                }).catch(error => {
                    console.error("Erreur lors de la génération du PDF:", error);
                    alert("Une erreur est survenue lors de la génération du PDF.");
                    loadingOverlay.style.display = 'none';
                    invoiceElement.style.display = originalDisplay;
                });
            }, 100);
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadForm();

            const formInputs = document.querySelectorAll('.form-section input, .form-section textarea, .form-section select');
            formInputs.forEach(input => {
                if (input.id !== 'clientEmail') {
                    input.addEventListener('input', generateInvoice);
                    input.addEventListener('change', generateInvoice);
                }
            });

            document.getElementById('services-list').addEventListener('input', (event) => {
                if (event.target.classList.contains('service-description') ||
                    event.target.classList.contains('service-unit-price')) {
                    generateInvoice();
                }
            });

            document.getElementById('addServiceButton').addEventListener('click', () => {
                addService();
                generateInvoice();
            });

            document.getElementById('services-list').addEventListener('click', (event) => {
                if (event.target.tagName === 'BUTTON' && event.target.textContent === 'Supprimer') {
                    removeService(event.target);
                }
            });

            document.getElementById('stayMotive').addEventListener('change', updateStayMotiveFields);

            document.getElementById('reposeCheckInTime').addEventListener('input', (event) => {
                const checkInTime = event.target.value;
                if (checkInTime) {
                    const [hours, minutes] = checkInTime.split(':').map(Number);
                    const date = new Date();
                    date.setHours(hours);
                    date.setMinutes(minutes);
                    date.setSeconds(0);
                    date.setMilliseconds(0);

                    date.setHours(date.getHours() + 3);

                    const outHours = String(date.getHours()).padStart(2, '0');
                    const outMinutes = String(date.getMinutes()).padStart(2, '0');
                    document.getElementById('reposeCheckOutTime').value = `${outHours}:${outMinutes}`;
                } else {
                    document.getElementById('reposeCheckOutTime').value = '';
                }
                generateInvoice();
            });

            // Ajouter des écouteurs pour les champs de réduction
            const discountTypeSelect = document.getElementById('discountType');
            const discountValueInput = document.getElementById('discountValue');
            const discountValueGroup = document.getElementById('discountValueGroup');

            discountTypeSelect.addEventListener('change', () => {
                if (discountTypeSelect.value === 'none') {
                    discountValueGroup.style.display = 'none';
                    discountValueInput.value = '0'; // Réinitialiser la valeur
                } else {
                    discountValueGroup.style.display = 'block';
                }
                generateInvoice();
            });

            discountValueInput.addEventListener('input', generateInvoice);

            generateInvoice();
        });

    </script>
</body>
</html>